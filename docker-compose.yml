services:
  localstack:
    image: localstack/localstack:latest
    ports:
      - "4566:4566"
    environment:
      - SERVICES=s3,sns,sqs
      - DEBUG=0
    healthcheck:
      test: ["CMD", "bash", "-c", "awslocal s3 ls || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 5
  cloud-eval:
    build: .
    depends_on:
      - localstack
    ports:
      - "5000:5000"
    env_file:
      - .env
    environment:
      - ENDPOINT_URL=http://localstack:4566
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - SERVICE_PORT=5000
    volumes:
      - ./tasks:/app/tasks:ro
      - ./reports:/app/reports
    entrypoint: ["./entrypoint.sh", "service"]
    develop:
      watch:
        - path: ./src
          action: rebuild
        - path: ./agents
          action: rebuild
        - path: ./tasks
          action: sync
          target: /app/tasks
  frontend:
    build:
      context: ./frontend
    ports:
      - "3000:3000"
    depends_on:
      - cloud-eval
    volumes:
      - ./reports:/app/reports:ro
    env_file:
      - .env
    environment:
      - PORT=3000
      - REPORTS_DIR=/app/reports
      - SUITE_SERVICE_URL=http://cloud-eval:5000
    develop:
      watch:
        - path: ./frontend/public
          action: sync
          target: /app/public
        - path: ./frontend/server.js
          action: rebuild
  auto-run:
    profiles: ["autorun"]
    image: curlimages/curl:8.4.0
    depends_on:
      - frontend
    develop:
      watch: []  # exclude from compose watch to avoid rebuild errors (no build context)
    entrypoint: >
      sh -c "
        echo 'Waiting for frontend...';
        until curl -sf http://frontend:3000/health >/dev/null 2>&1; do
          sleep 2;
        done;
        echo 'Triggering suite via frontend';
        curl -X POST http://frontend:3000/api/evaluate
      "
